#!/usr/bin/env ruby
require_relative "../config/environment"

event_type = ARGV[0] || "created"
host = ENV.fetch("PURCHASEKIT_HOST", "http://localhost:3000")
customer_id = ENV.fetch("CUSTOMER_ID", User.first.payment_processor.id.to_s)
subscription_id = ENV.fetch("SUBSCRIPTION_ID", "sub_#{Time.now.to_i}")
store_product_id = ENV.fetch("STORE_PRODUCT_ID", "purchasekit.pro.annual")
success_path = ENV.fetch("SUCCESS_PATH", "/paid")

now = Time.current.iso8601
period_end = 1.year.from_now.iso8601

payload = case event_type
when "created"
  {
    type: "subscription.created",
    customer_id: customer_id,
    subscription_id: subscription_id,
    store_product_id: store_product_id,
    subscription_name: "pro",
    status: "active",
    current_period_start: now,
    current_period_end: period_end,
    success_path: success_path
  }
when "updated"
  {
    type: "subscription.updated",
    subscription_id: subscription_id,
    store_product_id: store_product_id,
    status: "active",
    current_period_start: now,
    current_period_end: period_end
  }
when "canceled"
  {
    type: "subscription.canceled",
    subscription_id: subscription_id,
    ends_at: period_end
  }
when "expired"
  {
    type: "subscription.expired",
    subscription_id: subscription_id
  }
else
  puts "Unknown event type: #{event_type}"
  puts "Valid types: created, updated, canceled, expired"
  exit 1
end

url = "#{host}/purchasekit/webhooks"

puts "Sending #{payload[:type]} webhook to #{url}"
puts
puts "Payload:"
puts JSON.pretty_generate(payload)
puts

uri = URI(url)
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = uri.scheme == "https"

request = Net::HTTP::Post.new(uri.path)
request["Content-Type"] = "application/json"
request.body = payload.to_json

response = http.request(request)

puts "Response: HTTP #{response.code}"

if response.code != "200"
  puts
  puts "Response body:"
  puts response.body[0, 500]
end
